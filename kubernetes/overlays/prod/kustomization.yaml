apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# /kubernetes/overlays/prod/kustomization.yaml
# Universal Production Environment Overlay
# Works with: AWS EKS, Google GKE, Azure AKS, and other cloud Kubernetes platforms
# ArgoCD-compatible: no shell variable substitution — plain Kustomize only
#
# NOTE: No `labels` block here — Kustomize's labels transformer also injects
# label selectors onto resources, which causes issues on immutable fields.
# Environment labels are applied via the Deployment patch below.

resources:
  - ../../base
  - network-policy.yaml
  - pod-disruption-budget.yaml

namespace: devops-app

images:
  - name: devops-app
    newName: devops-app
    newTag: latest

patches:
  # Production-grade resource allocation and replica count
  - target:
      kind: Deployment
      name: devops-app
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: devops-app
        labels:
          environment: production
      spec:
        replicas: 3
        strategy:
          type: RollingUpdate
          rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0
        template:
          metadata:
            labels:
              environment: production
          spec:
            affinity:
              podAntiAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                      - key: app
                        operator: In
                        values:
                        - devops-app
                    topologyKey: kubernetes.io/hostname
            containers:
            - name: devops-app
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
              livenessProbe:
                httpGet:
                  path: /health
                  port: 3000
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 3
              readinessProbe:
                httpGet:
                  path: /ready
                  port: 3000
                initialDelaySeconds: 10
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 3

  # Production HPA configuration
  - target:
      kind: HorizontalPodAutoscaler
      name: devops-app-hpa
    patch: |-
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: devops-app-hpa
      spec:
        minReplicas: 2
        maxReplicas: 10
        metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              type: Utilization
              averageUtilization: 70
        - type: Resource
          resource:
            name: memory
            target:
              type: Utilization
              averageUtilization: 80
        behavior:
          scaleDown:
            stabilizationWindowSeconds: 300
            policies:
            - type: Percent
              value: 50
              periodSeconds: 60
          scaleUp:
            stabilizationWindowSeconds: 0
            policies:
            - type: Percent
              value: 100
              periodSeconds: 30
            - type: Pods
              value: 2
              periodSeconds: 30
            selectPolicy: Max

  # Universal LoadBalancer Service for cloud clusters
  - target:
      kind: Service
      name: devops-app-service
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: devops-app-service
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
          service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
          service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
          cloud.google.com/neg: '{"ingress": true}'
          cloud.google.com/backend-config: '{"default": "backend-config"}'
          service.beta.kubernetes.io/azure-load-balancer-internal: "false"
      spec:
        type: LoadBalancer
        sessionAffinity: ClientIP
        sessionAffinityConfig:
          clientIP:
            timeoutSeconds: 10800
        ports:
        - port: 80
          targetPort: 3000
          protocol: TCP
          name: http
        - port: 443
          targetPort: 3000
          protocol: TCP
          name: https

  # Universal Ingress configuration for cloud clusters
  - target:
      kind: Ingress
      name: devops-app-ingress
    patch: |-
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: devops-app-ingress
        annotations:
          alb.ingress.kubernetes.io/scheme: internet-facing
          alb.ingress.kubernetes.io/target-type: ip
          alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
          alb.ingress.kubernetes.io/ssl-redirect: '443'
          alb.ingress.kubernetes.io/healthcheck-path: /health
          kubernetes.io/ingress.global-static-ip-name: "devops-app-ip"
          networking.gke.io/managed-certificates: "devops-app-cert"
          appgw.ingress.kubernetes.io/ssl-redirect: "true"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
          cert-manager.io/cluster-issuer: letsencrypt-prod
      spec:
        ingressClassName: nginx
        tls:
        - hosts:
          - devops-app.local
          secretName: devops-app-tls
        rules:
        - host: devops-app.local
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: devops-app-service
                  port:
                    number: 80