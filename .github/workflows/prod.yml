# ============================================================================
# GitHub Actions Workflow — CI ONLY
# ============================================================================
# /.github/workflows/prod.yml
#
# ARCHITECTURE:
#   GitHub Actions = Validate + Build + Push Docker image (CI)
#   Argo CD        = All actual deployments (local + prod)
#
# After this pipeline pushes a new image, Argo CD detects the image tag change
# in kubernetes manifests and automatically deploys to the cluster.
#
# Configure secrets in: Repository → Settings → Secrets and variables → Actions
# ============================================================================

name: CI — Build, Test & Push

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      force_push:
        description: 'Force push image even if no code changes'
        required: false
        default: false
        type: boolean

env:
  # ── App ────────────────────────────────────────────────────────────────────
  APP_NAME:           ${{ vars.APP_NAME           || 'devops-app' }}
  NAMESPACE:          ${{ vars.NAMESPACE           || 'devops-app' }}
  APP_PORT:           ${{ vars.APP_PORT            || '3000' }}
  REPLICAS:           ${{ vars.REPLICAS            || '2' }}
  MIN_REPLICAS:       ${{ vars.MIN_REPLICAS        || '2' }}
  MAX_REPLICAS:       ${{ vars.MAX_REPLICAS        || '10' }}

  # ── Docker ─────────────────────────────────────────────────────────────────
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_IMAGE_TAG:   ${{ vars.DOCKER_IMAGE_TAG    || 'latest' }}

  # ── Ingress ────────────────────────────────────────────────────────────────
  INGRESS_ENABLED:    ${{ vars.INGRESS_ENABLED     || 'true' }}
  INGRESS_HOST:       ${{ vars.INGRESS_HOST        || 'devops-app.local' }}
  INGRESS_CLASS:      ${{ vars.INGRESS_CLASS       || 'nginx' }}
  TLS_ENABLED:        ${{ vars.TLS_ENABLED         || 'false' }}
  TLS_SECRET_NAME:    ${{ vars.TLS_SECRET_NAME     || 'devops-app-tls' }}

  # ── Database ───────────────────────────────────────────────────────────────
  DB_HOST:            ${{ vars.DB_HOST             || 'localhost' }}
  DB_PORT:            ${{ vars.DB_PORT             || '5432' }}
  DB_NAME:            ${{ vars.DB_NAME             || 'devopsdb' }}
  DB_USERNAME:        ${{ secrets.DB_USERNAME      || 'dbuser' }}

  # ── Monitoring ─────────────────────────────────────────────────────────────
  PROMETHEUS_ENABLED:        ${{ vars.PROMETHEUS_ENABLED        || 'true' }}
  PROMETHEUS_NAMESPACE:      ${{ vars.PROMETHEUS_NAMESPACE      || 'monitoring' }}
  PROMETHEUS_RETENTION:      ${{ vars.PROMETHEUS_RETENTION      || '15d' }}
  PROMETHEUS_STORAGE_SIZE:   ${{ vars.PROMETHEUS_STORAGE_SIZE   || '10Gi' }}
  PROMETHEUS_SCRAPE_INTERVAL: ${{ vars.PROMETHEUS_SCRAPE_INTERVAL || '15s' }}
  PROMETHEUS_SCRAPE_TIMEOUT: ${{ vars.PROMETHEUS_SCRAPE_TIMEOUT || '10s' }}
  GRAFANA_ENABLED:           ${{ vars.GRAFANA_ENABLED           || 'true' }}
  GRAFANA_ADMIN_USER:        ${{ vars.GRAFANA_ADMIN_USER        || 'admin' }}
  GRAFANA_PORT:              ${{ vars.GRAFANA_PORT              || '3000' }}
  GRAFANA_STORAGE_SIZE:      ${{ vars.GRAFANA_STORAGE_SIZE      || '5Gi' }}

  # ── Resource Limits — App ──────────────────────────────────────────────────
  APP_CPU_REQUEST:    ${{ vars.APP_CPU_REQUEST     || '100m' }}
  APP_CPU_LIMIT:      ${{ vars.APP_CPU_LIMIT       || '500m' }}
  APP_MEMORY_REQUEST: ${{ vars.APP_MEMORY_REQUEST  || '128Mi' }}
  APP_MEMORY_LIMIT:   ${{ vars.APP_MEMORY_LIMIT    || '512Mi' }}

  # ── Resource Limits — Prometheus ───────────────────────────────────────────
  PROMETHEUS_CPU_REQUEST:    ${{ vars.PROMETHEUS_CPU_REQUEST    || '500m' }}
  PROMETHEUS_CPU_LIMIT:      ${{ vars.PROMETHEUS_CPU_LIMIT      || '2000m' }}
  PROMETHEUS_MEMORY_REQUEST: ${{ vars.PROMETHEUS_MEMORY_REQUEST || '1Gi' }}
  PROMETHEUS_MEMORY_LIMIT:   ${{ vars.PROMETHEUS_MEMORY_LIMIT   || '4Gi' }}

  # ── Resource Limits — Grafana ──────────────────────────────────────────────
  GRAFANA_CPU_REQUEST:    ${{ vars.GRAFANA_CPU_REQUEST    || '100m' }}
  GRAFANA_CPU_LIMIT:      ${{ vars.GRAFANA_CPU_LIMIT      || '500m' }}
  GRAFANA_MEMORY_REQUEST: ${{ vars.GRAFANA_MEMORY_REQUEST || '256Mi' }}
  GRAFANA_MEMORY_LIMIT:   ${{ vars.GRAFANA_MEMORY_LIMIT   || '1Gi' }}

  # ── AWS / EKS ──────────────────────────────────────────────────────────────
  AWS_REGION:         ${{ vars.AWS_REGION          || 'us-east-1' }}
  EKS_CLUSTER_NAME:   ${{ vars.EKS_CLUSTER_NAME    || 'devops-cluster' }}

  # ── Git ────────────────────────────────────────────────────────────────────
  GIT_AUTHOR_NAME:    ${{ vars.GIT_AUTHOR_NAME     || github.actor }}
  GIT_AUTHOR_EMAIL:   ${{ vars.GIT_AUTHOR_EMAIL    || format('{0}@users.noreply.github.com', github.actor) }}

  # ── Loki ───────────────────────────────────────────────────────────────────
  LOKI_ENABLED:          ${{ vars.LOKI_ENABLED          || 'true' }}
  LOKI_NAMESPACE:        ${{ vars.LOKI_NAMESPACE        || 'loki' }}
  LOKI_RETENTION_PERIOD: ${{ vars.LOKI_RETENTION_PERIOD || '168h' }}
  LOKI_STORAGE_SIZE:     ${{ vars.LOKI_STORAGE_SIZE     || '10Gi' }}

  # ── Security / Trivy ───────────────────────────────────────────────────────
  TRIVY_ENABLED:         ${{ vars.TRIVY_ENABLED         || 'true' }}
  TRIVY_NAMESPACE:       ${{ vars.TRIVY_NAMESPACE        || 'trivy-system' }}
  TRIVY_SEVERITY:        ${{ vars.TRIVY_SEVERITY         || 'HIGH,CRITICAL' }}
  TRIVY_METRICS_ENABLED: ${{ vars.TRIVY_METRICS_ENABLED  || 'true' }}

  # ── CI flag ────────────────────────────────────────────────────────────────
  CI: true

# ============================================================================
jobs:

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 1 — Validate required variables & secrets
  # ────────────────────────────────────────────────────────────────────────────
  validate:
    name: Validate Variables & Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required variables
        run: |
          echo "============================================================================"
          echo "Validating Required CI Variables"
          echo "============================================================================"

          REQUIRED_VARS=(APP_NAME NAMESPACE DOCKERHUB_USERNAME DOCKER_IMAGE_TAG APP_PORT REPLICAS)
          MISSING=()

          for var in "${REQUIRED_VARS[@]}"; do
            if [[ -z "${!var}" ]]; then
              MISSING+=("$var")
            fi
          done

          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo "❌ Missing required variables:"
            for v in "${MISSING[@]}"; do echo "   - $v"; done
            echo ""
            echo "Configure at: Settings → Secrets and variables → Actions"
            exit 1
          fi
          echo "✅ All required variables present"

      - name: Validate secrets
        run: |
          echo "Checking secrets (values hidden)..."
          WARN=()
          [[ -z "${{ secrets.DOCKERHUB_PASSWORD }}" ]] && WARN+=("DOCKERHUB_PASSWORD")
          [[ -z "${{ secrets.DB_PASSWORD }}"        ]] && WARN+=("DB_PASSWORD")
          [[ -z "${{ secrets.JWT_SECRET }}"         ]] && WARN+=("JWT_SECRET")

          if [[ ${#WARN[@]} -gt 0 ]]; then
            echo "⚠️  Warning — missing optional secrets:"
            for s in "${WARN[@]}"; do echo "   - $s"; done
          else
            echo "✅ All secrets configured"
          fi

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 2 — Lint & static analysis
  # ────────────────────────────────────────────────────────────────────────────
  lint:
    name: Lint & Static Analysis
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint shell scripts
        run: |
          echo "============================================================================"
          echo "Linting Shell Scripts"
          echo "============================================================================"
          if command -v shellcheck >/dev/null 2>&1; then
            find . -name "*.sh" -not -path "./.git/*" | xargs shellcheck --severity=warning || true
            echo "✅ ShellCheck complete"
          else
            sudo apt-get install -y shellcheck -q
            find . -name "*.sh" -not -path "./.git/*" | xargs shellcheck --severity=warning || true
            echo "✅ ShellCheck complete"
          fi

      - name: Validate Kubernetes manifests
        run: |
          echo "============================================================================"
          echo "Validating Kubernetes Manifests"
          echo "============================================================================"

          # Install kubeval
          if ! command -v kubeval >/dev/null 2>&1; then
            curl -sSL https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz \
              | tar xz -C /tmp
            sudo mv /tmp/kubeval /usr/local/bin/kubeval
          fi

          # Set dummy vars for envsubst so validation doesn't fail on templates
          export APP_NAME="${APP_NAME}" NAMESPACE="${NAMESPACE}" \
            DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME:-dummy}" \
            DOCKER_IMAGE_TAG="${DOCKER_IMAGE_TAG}" APP_PORT="${APP_PORT}" \
            REPLICAS="${REPLICAS}" MIN_REPLICAS="${MIN_REPLICAS}" \
            MAX_REPLICAS="${MAX_REPLICAS}" INGRESS_HOST="${INGRESS_HOST}" \
            INGRESS_CLASS="${INGRESS_CLASS}" TLS_SECRET_NAME="${TLS_SECRET_NAME}" \
            PROMETHEUS_NAMESPACE="${PROMETHEUS_NAMESPACE}" \
            CPU_TARGET_UTILIZATION="70" MEMORY_TARGET_UTILIZATION="80" \
            APP_CPU_REQUEST="${APP_CPU_REQUEST}" APP_CPU_LIMIT="${APP_CPU_LIMIT}" \
            APP_MEMORY_REQUEST="${APP_MEMORY_REQUEST}" APP_MEMORY_LIMIT="${APP_MEMORY_LIMIT}" \
            DB_HOST="${DB_HOST}" DB_PORT="${DB_PORT}" DB_NAME="${DB_NAME}" \
            DB_USERNAME="${DB_USERNAME:-dummy}" DB_PASSWORD="dummy" \
            JWT_SECRET="dummy" API_KEY="dummy" SESSION_SECRET="dummy" \
            K8S_DISTRIBUTION="kubernetes" K8S_SERVICE_TYPE="ClusterIP" \
            K8S_INGRESS_CLASS="nginx" K8S_SUPPORTS_LOADBALANCER="false" \
            INGRESS_ENABLED="${INGRESS_ENABLED}"

          find kubernetes/base -name "*.yaml" | while read -r f; do
            envsubst < "$f" | kubeval --ignore-missing-schemas --quiet && \
              echo "  ✅ $f" || echo "  ⚠️  $f (validation warning)"
          done

      - name: Check .env example completeness
        run: |
          echo "============================================================================"
          echo "Checking dotenv_example covers all variables used in manifests"
          echo "============================================================================"
          # Extract all ${VAR} patterns from k8s manifests
          USED=$(grep -roh '\${[A-Z_]\+}' kubernetes/ monitoring/ Security/ 2>/dev/null \
            | sort -u | sed 's/[${}]//g')
          MISSING_FROM_EXAMPLE=()
          while IFS= read -r var; do
            grep -q "^${var}=" dotenv_example 2>/dev/null || MISSING_FROM_EXAMPLE+=("$var")
          done <<< "$USED"
          if [[ ${#MISSING_FROM_EXAMPLE[@]} -gt 0 ]]; then
            echo "⚠️  Variables used in manifests but missing from dotenv_example:"
            for v in "${MISSING_FROM_EXAMPLE[@]}"; do echo "   - $v"; done
          else
            echo "✅ dotenv_example covers all manifest variables"
          fi

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 3 — Run application tests
  # ────────────────────────────────────────────────────────────────────────────
  test:
    name: Application Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package.json

      - name: Install dependencies
        working-directory: app
        run: npm ci

      - name: Run tests
        working-directory: app
        run: |
          echo "============================================================================"
          echo "Running Application Tests"
          echo "============================================================================"
          npm test --if-present || echo "ℹ️  No test script defined — skipping"

      - name: Run security audit
        working-directory: app
        run: |
          echo "============================================================================"
          echo "NPM Security Audit"
          echo "============================================================================"
          npm audit --audit-level=high || echo "⚠️  Audit found issues — review above"

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 4 — Build & Push Docker image
  # Runs only on push to main/develop (not on PRs)
  # ────────────────────────────────────────────────────────────────────────────
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: |
      github.event_name == 'push' ||
      github.event.inputs.force_push == 'true'
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      image_digest: ${{ steps.push.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          # Use git SHA for precise image tagging
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          BRANCH="${{ github.ref_name }}"
          BRANCH="${BRANCH//\//-}"     # replace / with -

          # Tag strategy:
          #   main branch  → latest + sha
          #   other branch → branch-name + sha
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            IMAGE_TAG="${{ env.DOCKER_IMAGE_TAG }}"
          else
            IMAGE_TAG="${BRANCH}-${SHORT_SHA}"
          fi

          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH"       >> "$GITHUB_OUTPUT"
          echo ""
          echo "  Image: ${{ env.DOCKERHUB_USERNAME }}/${{ env.APP_NAME }}:$IMAGE_TAG"

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push
        id: push
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.APP_NAME }}:${{ steps.meta.outputs.image_tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.APP_NAME }}:sha-${{ github.sha }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Print image summary
        run: |
          echo "============================================================================"
          echo "✅ Image Built and Pushed"
          echo "============================================================================"
          echo "  Repository: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.APP_NAME }}"
          echo "  Tag:        ${{ steps.meta.outputs.image_tag }}"
          echo "  Digest:     ${{ steps.push.outputs.digest }}"
          echo ""
          echo "  Argo CD will automatically detect this new image and deploy."
          echo "  Monitor at: argocd app list"

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 5 — Security scan on built image
  # ────────────────────────────────────────────────────────────────────────────
  scan-image:
    name: Trivy Image Scan (CI)
    runs-on: ubuntu-latest
    needs: build-and-push
    if: needs.build-and-push.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/${{ env.APP_NAME }}:${{ needs.build-and-push.outputs.image_tag }}'
          format: 'table'
          exit-code: '0'           # Don't fail CI — Trivy in cluster will alert via Prometheus
          severity: 'HIGH,CRITICAL'
          vuln-type: 'os,library'

      - name: Upload Trivy scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-results
          path: trivy-results.sarif
          retention-days: 30

  # ────────────────────────────────────────────────────────────────────────────
  # JOB 6 — Notify ArgoCD (optional webhook trigger for immediate sync)
  # ────────────────────────────────────────────────────────────────────────────
  notify-argocd:
    name: Notify Argo CD
    runs-on: ubuntu-latest
    needs: build-and-push
    if: |
      needs.build-and-push.result == 'success' &&
      github.ref_name == 'main'
    steps:
      - name: Trigger ArgoCD sync via webhook
        run: |
          echo "============================================================================"
          echo "Notifying Argo CD of New Image"
          echo "============================================================================"
          echo ""
          echo "  Image tag: ${{ needs.build-and-push.outputs.image_tag }}"
          echo ""

          # If ARGOCD_WEBHOOK_URL is configured, trigger immediate sync
          if [[ -n "${{ secrets.ARGOCD_WEBHOOK_URL }}" ]]; then
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "${{ secrets.ARGOCD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"ref":"${{ github.ref }}","repository":{"html_url":"${{ github.server_url }}/${{ github.repository }}"}}')
            echo "  ArgoCD webhook response: HTTP $HTTP_STATUS"
          else
            echo "  ℹ️  ARGOCD_WEBHOOK_URL not set — ArgoCD will poll and sync automatically"
            echo "     (default poll interval: 3 minutes)"
            echo ""
            echo "  To enable instant sync, set ARGOCD_WEBHOOK_URL in GitHub Secrets."
            echo "  Guide: https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/"
          fi

  # ────────────────────────────────────────────────────────────────────────────
  # SUMMARY JOB — Always runs, shows pipeline outcome
  # ────────────────────────────────────────────────────────────────────────────
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate, lint, test, build-and-push, scan-image, notify-argocd]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "============================================================================"
          echo "CI Pipeline Summary"
          echo "============================================================================"
          echo ""
          echo "  validate:      ${{ needs.validate.result }}"
          echo "  lint:          ${{ needs.lint.result }}"
          echo "  test:          ${{ needs.test.result }}"
          echo "  build-push:    ${{ needs.build-and-push.result }}"
          echo "  scan-image:    ${{ needs.scan-image.result }}"
          echo "  notify-argo:   ${{ needs.notify-argocd.result }}"
          echo ""
          echo "  Branch:        ${{ github.ref_name }}"
          echo "  Commit:        ${{ github.sha }}"
          echo "  Triggered by:  ${{ github.actor }}"
          echo ""
          echo "  ✅ Deployment is handled by Argo CD (not GitHub Actions)"
          echo "  Monitor deployments: kubectl get applications -n argocd"
          echo "============================================================================"