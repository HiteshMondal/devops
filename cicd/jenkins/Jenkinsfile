#!/usr/bin/env groovy

/**
 * /cicd/jenkins/Jenkinsfile
 * Jenkins Pipeline for DevOps Application
 * Builds, tests, and deploys containerized application to Kubernetes
 * 
 * Required Jenkins Credentials:
 * - dockerhub-credentials: DockerHub username and password
 * - kubeconfig: Kubernetes config file for cluster access
 * 
 * Required Environment Variables (Configure in Jenkins):
 * - DOCKERHUB_USERNAME
 * - APP_NAME
 * - NAMESPACE
 * - DOCKER_IMAGE_TAG
 * - DEPLOY_TARGET (local/prod)
 */

pipeline {
    agent any
    
    environment {
    BUILD_NUMBER = "${env.BUILD_NUMBER}"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        stage('Init') {
            steps {
                script {
                    env.APP_NAME = env.APP_NAME ?: "devops-app"
                    env.NAMESPACE = env.NAMESPACE ?: "devops-app"
                    env.DOCKER_IMAGE_TAG = env.DOCKER_IMAGE_TAG ?: "latest"
                    env.DEPLOY_TARGET = env.DEPLOY_TARGET ?: "local"
                    env.IMAGE_NAME = "${env.DOCKERHUB_USERNAME}/${env.APP_NAME}:${env.DOCKER_IMAGE_TAG}"
                    env.GIT_COMMIT_SHORT =
                        env.GIT_COMMIT ? env.GIT_COMMIT.take(7) : "unknown"
                }
            }
        }

        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out source code...'
                checkout scm
                
                script {
                    // Display build information
                    sh '''
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "  Build Information"
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "  App Name:        ${APP_NAME}"
                        echo "  Namespace:       ${NAMESPACE}"
                        echo "  Image:           ${IMAGE_NAME}"
                        echo "  Deploy Target:   ${DEPLOY_TARGET}"
                        echo "  Build Number:    ${BUILD_NUMBER}"
                        echo "  Git Commit:      ${GIT_COMMIT_SHORT}"
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    '''
                }
            }
        }
        
        stage('Environment Check') {
            steps {
                echo 'ğŸ” Checking environment and tools...'
                sh '''
                    echo "Tool versions:"
                    docker --version || echo "âŒ Docker not found"
                    kubectl version --client || echo "âŒ kubectl not found"
                    git --version || echo "âŒ Git not found"
                    echo ""
                    echo "âœ… Environment check complete"
                '''
            }
        }
        
        stage('Build Application') {
            steps {
                echo 'ğŸ”¨ Building Docker image...'
                dir('app') {
                    script {
                        sh '''
                            docker build \
                                --tag ${IMAGE_NAME} \
                                --tag ${DOCKERHUB_USERNAME}/${APP_NAME}:build-${BUILD_NUMBER} \
                                --tag ${DOCKERHUB_USERNAME}/${APP_NAME}:${GIT_COMMIT_SHORT} \
                                --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                                --build-arg VCS_REF=${GIT_COMMIT_SHORT} \
                                --build-arg BUILD_NUMBER=${BUILD_NUMBER} \
                                .
                        '''
                    }
                }
                echo 'âœ… Docker image built successfully'
            }
        }
        
        stage('Test Application') {
            steps {
                echo 'ğŸ§ª Running tests...'
                script {
                    sh '''
                        # Run container in test mode
                        echo "Starting test container..."
                        CONTAINER_ID=$(docker run -d --rm \
                            -e NODE_ENV=test \
                            ${IMAGE_NAME})
                        
                        # Wait for app to start
                        sleep 5
                        
                        # Check if container is still running
                        if docker ps | grep -q ${CONTAINER_ID}; then
                            echo "âœ… Container health check passed"
                            docker stop ${CONTAINER_ID} || true
                        else
                            echo "âŒ Container failed to start"
                            docker logs ${CONTAINER_ID} || true
                            exit 1
                        fi
                    '''
                }
                echo 'âœ… Tests passed'
            }
        }
        
        stage('Security Scan') {
            steps {
                echo 'ğŸ”’ Scanning image for vulnerabilities...'
                script {
                    // Basic security checks
                    sh '''
                        # Check image size
                        IMAGE_SIZE=$(docker images ${IMAGE_NAME} --format "{{.Size}}")
                        echo "Image size: ${IMAGE_SIZE}"
                        
                        # Check for common vulnerabilities (basic check)
                        echo "Running basic security checks..."
                        docker history ${IMAGE_NAME} | grep -i "password\\|secret\\|token" && {
                            echo "âš ï¸  Warning: Potential secrets in image history"
                        } || echo "âœ… No obvious secrets in image history"
                        
                        # TODO: Integrate with Trivy or similar scanner
                        echo "ğŸ’¡ Consider integrating Trivy for comprehensive scanning"
                    '''
                }
                echo 'âœ… Security scan complete'
            }
        }
        
        stage('Push to Registry') {
            when {
                expression { env.DEPLOY_TARGET == 'prod' || env.BUILD_PUSH == 'true' }
            }
            steps {
                echo 'ğŸ“¤ Pushing image to DockerHub...'
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh '''
                            echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
                            
                            # Push all tags
                            docker push ${IMAGE_NAME}
                            docker push ${DOCKERHUB_USERNAME}/${APP_NAME}:build-${BUILD_NUMBER}
                            docker push ${DOCKERHUB_USERNAME}/${APP_NAME}:${GIT_COMMIT_SHORT}
                            
                            echo "âœ… Images pushed:"
                            echo "   - ${IMAGE_NAME}"
                            echo "   - ${DOCKERHUB_USERNAME}/${APP_NAME}:build-${BUILD_NUMBER}"
                            echo "   - ${DOCKERHUB_USERNAME}/${APP_NAME}:${GIT_COMMIT_SHORT}"
                        '''
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                echo 'ğŸš€ Deploying to Kubernetes...'
                script {
                    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
                        sh '''
                            # Set kubeconfig
                            export KUBECONFIG=${KUBECONFIG_FILE}
                            
                            # Verify cluster connection
                            echo "Verifying cluster connection..."
                            kubectl cluster-info || {
                                echo "âŒ Cannot connect to Kubernetes cluster"
                                exit 1
                            }
                            
                            # Create namespace if it doesn't exist
                            kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                            
                            # Deploy using Kustomize
                            echo "Deploying application..."
                            cd kubernetes/overlays/${DEPLOY_TARGET}
                            
                            # Update image in kustomization
                            kustomize edit set image ${APP_NAME}=${IMAGE_NAME}
                            
                            # Apply the deployment
                            kubectl apply -k . || {
                                echo "âŒ Deployment failed"
                                exit 1
                            }
                            
                            # Wait for rollout
                            echo "Waiting for deployment to complete..."
                            kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --timeout=5m || {
                                echo "âŒ Rollout failed or timed out"
                                kubectl get pods -n ${NAMESPACE}
                                exit 1
                            }
                            
                            echo "âœ… Deployment successful"
                        '''
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo 'âœ… Verifying deployment...'
                script {
                    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
                        sh '''
                            export KUBECONFIG=${KUBECONFIG_FILE}
                            
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            echo "  Deployment Status"
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            
                            echo "Pods:"
                            kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME}
                            
                            echo ""
                            echo "Services:"
                            kubectl get svc -n ${NAMESPACE} -l app=${APP_NAME}
                            
                            echo ""
                            echo "Deployment:"
                            kubectl get deployment ${APP_NAME} -n ${NAMESPACE}
                            
                            echo ""
                            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                            
                            # Check if pods are running
                            RUNNING_PODS=$(kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME} --field-selector=status.phase=Running --no-headers | wc -l)
                            if [ ${RUNNING_PODS} -gt 0 ]; then
                                echo "âœ… ${RUNNING_PODS} pod(s) running successfully"
                            else
                                echo "âŒ No pods are running"
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Pipeline completed successfully!'
            script {
                sh '''
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "  ğŸ‰ Deployment Successful"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "  Application:  ${APP_NAME}"
                    echo "  Namespace:    ${NAMESPACE}"
                    echo "  Image:        ${IMAGE_NAME}"
                    echo "  Build:        #${BUILD_NUMBER}"
                    echo "  Commit:       ${GIT_COMMIT_SHORT}"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                '''
            }
        }
        
        failure {
            echo 'âŒ Pipeline failed!'
            script {
                sh '''
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "  âŒ Deployment Failed"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "  Check logs above for error details"
                    echo "  Build:        #${BUILD_NUMBER}"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                '''
            }
        }
        
        always {
            node {
                echo 'ğŸ§¹ Cleaning up...'
                sh '''
                    # Clean up old images to save space
                    docker image prune -f --filter "until=24h" || true
                '''
            }
        }
    }
}