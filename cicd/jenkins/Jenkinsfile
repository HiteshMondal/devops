pipeline {
    agent any
    
    environment {
        // These should be configured as Jenkins credentials
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-creds')
        GITHUB_CREDENTIALS = credentials('github-creds')
        
        // These can be set in Jenkins or from .env
        DOCKERHUB_USERNAME = "${env.DOCKERHUB_USERNAME ?: 'your-dockerhub-username'}"
        APP_NAME = "${env.APP_NAME ?: 'devops-app'}"
        NAMESPACE = "${env.NAMESPACE ?: 'devops-app'}"
        IMAGE_TAG = "${env.IMAGE_TAG ?: "${env.GIT_COMMIT?.take(7) ?: 'latest'}"}"
        
        // Constructed variables
        DOCKER_IMAGE = "${DOCKERHUB_USERNAME}/${APP_NAME}:${IMAGE_TAG}"
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out code...'
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    env.IMAGE_TAG = env.GIT_COMMIT_SHORT
                    env.DOCKER_IMAGE = "${DOCKERHUB_USERNAME}/${APP_NAME}:${env.IMAGE_TAG}"
                }
                echo "üè∑Ô∏è  Image tag: ${env.IMAGE_TAG}"
            }
        }
        
        stage('Build') {
            steps {
                echo 'üî® Building Docker image...'
                script {
                    sh """
                        docker build \
                          -t ${env.DOCKER_IMAGE} \
                          -t ${DOCKERHUB_USERNAME}/${APP_NAME}:latest \
                          ./app
                    """
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'üß™ Running tests...'
                script {
                    // Add your test commands here
                    sh """
                        echo "Running unit tests..."
                        # docker run --rm ${env.DOCKER_IMAGE} npm test
                        echo "‚úÖ Tests passed!"
                    """
                }
            }
        }
        
        stage('Push to Registry') {
            when {
                branch 'main'
            }
            steps {
                echo 'üì¶ Pushing image to DockerHub...'
                script {
                    sh """
                        echo ${DOCKERHUB_CREDENTIALS_PSW} | docker login -u ${DOCKERHUB_CREDENTIALS_USR} --password-stdin
                        docker push ${env.DOCKER_IMAGE}
                        docker push ${DOCKERHUB_USERNAME}/${APP_NAME}:latest
                        docker logout
                    """
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            when {
                branch 'main'
            }
            steps {
                echo 'üöÄ Deploying to Kubernetes...'
                script {
                    sh """
                        # Ensure namespace exists
                        kubectl get namespace ${NAMESPACE} || kubectl create namespace ${NAMESPACE}
                        
                        # Update deployment with new image
                        kubectl set image deployment/${APP_NAME} \
                          ${APP_NAME}=${env.DOCKER_IMAGE} \
                          -n ${NAMESPACE} \
                          --record
                        
                        # Wait for rollout to complete
                        kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --timeout=5m
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Cleaning up...'
            sh """
                docker image prune -f --filter "until=24h"
            """
        }
        success {
            echo '‚úÖ Pipeline completed successfully!'
            echo "üåê Application URL: http://\$(kubectl get svc ${APP_NAME}-service -n ${NAMESPACE} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo 'localhost')"
        }
        failure {
            echo '‚ùå Pipeline failed!'
        }
    }
}