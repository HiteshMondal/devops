stages:
  - deploy

variables:
  PROJECT_ROOT: "$CI_PROJECT_DIR"
  APP_NAME: devops-app
  NAMESPACE: devops-app
  IMAGE_NAME: devops-app
  IMAGE_TAG: latest

default:
  image: yourdockerhubusername/devops-ci:latest
  tags:
    - self-hosted
    - docker
    - minikube

before_script:
  - docker info
  - kubectl version --client
  - minikube version

deploy:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

  script:
    # Install Node deps
    - echo "ðŸ“¦ Installing app dependencies"
    - cd app
    - npm install
    - cd "$PROJECT_ROOT"

    # Start Minikube
    - |
      if [[ "$(sudo minikube status --format='{{.Host}}')" != "Running" ]]; then
        sudo minikube start --driver=docker
        sudo minikube addons enable ingress
      fi

    # Build image inside Minikube
    - eval "$(sudo minikube docker-env)"
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" ./app

    # Deploy app
    - kubectl kustomize kubernetes/overlays/local | kubectl apply -f -

    # Monitoring stack
    - |
      echo "ðŸ“Š Deploying Monitoring Stack"

      BASE_MONITORING_PATH="$PROJECT_ROOT/kubernetes/base/monitoring"
      PROM_CONFIG="$PROJECT_ROOT/monitoring/prometheus/prometheus.yml"
      PROM_ALERTS="$PROJECT_ROOT/monitoring/prometheus/alerts.yml"

      kubectl apply -f - <<EOF
      apiVersion: v1
      kind: Namespace
      metadata:
        name: monitoring
      EOF

      : "${GRAFANA_ADMIN_PASSWORD:=admin123}"

      kubectl create secret generic grafana-secrets \
        --from-literal=admin-password="$GRAFANA_ADMIN_PASSWORD" \
        -n monitoring \
        --dry-run=client -o yaml | kubectl apply -f -

      kubectl apply -f "$BASE_MONITORING_PATH/dashboard-configmap.yaml"

      kubectl create configmap prometheus-config \
        --from-file=prometheus.yml="$PROM_CONFIG" \
        --from-file=alerts.yml="$PROM_ALERTS" \
        -n monitoring \
        --dry-run=client -o yaml | kubectl apply -f -

      kubectl apply -f "$BASE_MONITORING_PATH/prometheus.yaml"
      kubectl apply -f "$BASE_MONITORING_PATH/grafana.yaml"

      kubectl rollout restart deployment/prometheus -n monitoring
      kubectl rollout restart deployment/grafana -n monitoring

    # Expose services
    - |
      kubectl apply -f - <<EOF
      apiVersion: v1
      kind: Service
      metadata:
        name: grafana
        namespace: monitoring
      spec:
        selector:
          app: grafana
        ports:
          - port: 3000
            targetPort: 3000
        type: NodePort
      EOF

    # Output URLs
    - |
      MINIKUBE_IP=$(sudo minikube ip)

      APP_PORT=$(kubectl get svc devops-app-service -n devops-app -o jsonpath='{.spec.ports[0].nodePort}')
      GRAF_PORT=$(kubectl get svc grafana -n monitoring -o jsonpath='{.spec.ports[0].nodePort}')

      echo ""
      echo "ðŸš€ Deployment URLs"
      echo "- App: http://$MINIKUBE_IP:$APP_PORT"
      echo "- Grafana: http://$MINIKUBE_IP:$GRAF_PORT"
