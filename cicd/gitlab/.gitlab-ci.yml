#!/usr/bin/env bash
# /cicd/gitlab/configure_gitlab.sh â€” GitLab CI/CD Setup Guide
# Provides interactive guidance for committing code and registering a GitLab Runner

# â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -z "${PROJECT_ROOT:-}" ]]; then
    PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
fi
source "${PROJECT_ROOT}/lib/bootstrap.sh"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  MAIN
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
configure_gitlab() {
    print_section "GITLAB CI/CD SETUP GUIDE" "ðŸ¦Š"

    local SCRIPT_DIR
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

    cd "$PROJECT_ROOT" || {
        print_error "Cannot cd to project root: ${PROJECT_ROOT}"
        return 1
    }

    if [[ ! -d .git ]]; then
        print_warning "Not a Git repository â€” skipping GitLab CI/CD setup"
        return 0
    fi

    # â”€â”€ Step 1: Git Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print_subsection "Step 1 â€” Git Repository Status"
    echo ""
    git status
    echo ""

    print_access_box "COMMIT & PUSH YOUR CHANGES" "ðŸ“¤" \
        "CMD:Stage all changes:|git add ." \
        "CMD:Commit:|git commit -m 'your commit message'" \
        "CMD:Push to GitLab:|git push gitlab main"

    print_divider

    # â”€â”€ Step 2: Register Runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print_subsection "Step 2 â€” Register GitLab Runner  (Docker Executor)"
    echo ""
    print_info "Get your registration token from:"
    print_url "GitLab project" "https://gitlab.com/<username>/<project> â†’ Settings â†’ CI/CD â†’ Runners"
    echo ""

    print_access_box "RUNNER REGISTRATION" "âš™" \
        "CMD:Run this command (interactive prompts will guide you):|sudo gitlab-runner register \\" \
        "TEXT:    --url https://gitlab.com/ \\" \
        "TEXT:    --registration-token <YOUR_REGISTRATION_TOKEN> \\" \
        "TEXT:    --executor docker \\" \
        "TEXT:    --docker-image ubuntu:22.04 \\" \
        "TEXT:    --description 'devops-runner' \\" \
        "TEXT:    --tag-list 'devops,ci' \\" \
        "TEXT:    --run-untagged='false'" \
        "SEP:" \
        "CRED:Executor:docker" \
        "CRED:Image:ubuntu:22.04" \
        "CRED:Tags:devops Â· ci" \
        "CRED:Run untagged:false"

    print_divider

    # â”€â”€ Step 3: Start Runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print_subsection "Step 3 â€” Start the GitLab Runner"

    print_access_box "START & VERIFY RUNNER" "â–¶" \
        "CMD:Start runner service:|sudo gitlab-runner start" \
        "BLANK:" \
        "CMD:Check runner status:|sudo gitlab-runner status" \
        "BLANK:" \
        "CMD:View runner logs:|sudo gitlab-runner logs"

    print_divider

    # â”€â”€ Step 4: Verify in GitLab UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print_subsection "Step 4 â€” Verify Runner in GitLab UI"
    echo ""
    print_info "In your GitLab project, navigate to:"
    print_url "Settings â†’ CI/CD â†’ Runners" "https://gitlab.com/<username>/<project>/-/settings/ci_cd"
    echo ""
    print_info "Confirm the runner appears as active with tags:"
    print_target "${BOLD}devops${RESET}"
    print_target "${BOLD}ci${RESET}"
    echo ""
    print_divider

    # â”€â”€ Done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print_section "GITLAB CI/CD SETUP COMPLETE" "âœ…"
    print_success "Runner is configured and ready"
    echo ""
    print_info "Next steps:"
    print_target "Push a commit to trigger the first pipeline"
    print_target "Monitor pipeline execution in GitLab UI  (CI/CD â†’ Pipelines)"
    print_target "View runner logs:  ${ACCENT_CMD}sudo gitlab-runner logs${RESET}"
    echo ""
    print_divider
}

# â”€â”€ Direct execution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    configure_gitlab
fi