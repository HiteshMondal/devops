# ansible/roles/common/tasks/main.yml
# Common configuration for all servers

---
- name: Set timezone
  community.general.timezone:
    name: "{{ timezone | default('UTC') }}"
  tags:
    - common
    - timezone

- name: Install common packages
  ansible.builtin.yum:
    name:
      - vim
      - git
      - curl
      - wget
      - htop
      - net-tools
      - telnet
      - nc
      - bind-utils
      - sysstat
      - iotop
      - lsof
      - strace
      - tcpdump
      - unzip
      - tar
      - rsync
      - jq
      - python3
      - python3-pip
    state: present
  tags:
    - common
    - packages

- name: Upgrade pip
  ansible.builtin.pip:
    name: pip
    state: latest
    executable: pip3
  tags:
    - common
    - python

- name: Install Python packages
  ansible.builtin.pip:
    name:
      - boto3
      - botocore
      - requests
      - psycopg2-binary
    state: present
    executable: pip3
  tags:
    - common
    - python

- name: Configure hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  tags:
    - common
    - hostname

- name: Update /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "127.0.0.1 {{ inventory_hostname }}"
    state: present
  tags:
    - common
    - hosts

- name: Set up logrotate for application logs
  ansible.builtin.copy:
    dest: /etc/logrotate.d/application
    content: |
      /var/log/app/*.log {
          daily
          rotate 14
          compress
          delaycompress
          notifempty
          create 0644 {{ app_user | default('ec2-user') }} {{ app_group | default('ec2-user') }}
          sharedscripts
          postrotate
              systemctl reload {{ app_service_name | default('application') }} > /dev/null 2>&1 || true
          endscript
      }
    mode: '0644'
  tags:
    - common
    - logging

- name: Configure system limits
  ansible.builtin.pam_limits:
    domain: '*'
    limit_type: "{{ item.limit_type }}"
    limit_item: "{{ item.limit_item }}"
    value: "{{ item.value }}"
  loop:
    - { limit_type: 'soft', limit_item: 'nofile', value: '65536' }
    - { limit_type: 'hard', limit_item: 'nofile', value: '65536' }
    - { limit_type: 'soft', limit_item: 'nproc', value: '65536' }
    - { limit_type: 'hard', limit_item: 'nproc', value: '65536' }
  tags:
    - common
    - limits

- name: Configure sysctl parameters
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: 'net.ipv4.tcp_fin_timeout', value: '30' }
    - { name: 'net.ipv4.tcp_keepalive_time', value: '300' }
    - { name: 'net.ipv4.tcp_keepalive_probes', value: '5' }
    - { name: 'net.ipv4.tcp_keepalive_intvl', value: '15' }
    - { name: 'net.core.somaxconn', value: '65535' }
    - { name: 'net.ipv4.tcp_max_syn_backlog', value: '65535' }
    - { name: 'vm.swappiness', value: '10' }
  tags:
    - common
    - sysctl

- name: Create application user
  ansible.builtin.user:
    name: "{{ app_user | default('appuser') }}"
    comment: "Application User"
    shell: /bin/bash
    create_home: yes
  tags:
    - common
    - users

- name: Create application directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ app_user | default('appuser') }}"
    group: "{{ app_group | default('appuser') }}"
    mode: '0755'
  loop:
    - /opt/app
    - /var/log/app
    - /var/run/app
  tags:
    - common
    - directories

- name: Configure NTP
  ansible.builtin.systemd:
    name: chronyd
    state: started
    enabled: yes
  tags:
    - common
    - ntp

- name: Disable unnecessary services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: no
  loop:
    - postfix
  ignore_errors: yes
  tags:
    - common
    - services